---
title: "Week 9: Hierarchical GLM"
date: today
date-format: "DD/MM/YY"
format: pdf
execute: 
  warning: false
  message: false
---

# Lip cancer

Here is the lip cancer data that was used in the lecture. 

- `aff.i` is proportion of male population working outside in each region
- `observe.i` is observed deaths in each region
- `expect.i` is expected deaths, based on region-specific age distribution and national-level age-specific mortality rates. 

```{r}
observe.i <- c(
  5,13,18,5,10,18,29,10,15,22,4,11,10,22,13,14,17,21,25,6,11,21,13,5,19,18,14,17,3,10,
  7,3,12,11,6,16,13,6,9,10,4,9,11,12,23,18,12,7,13,12,12,13,6,14,7,18,13,9,6,8,7,6,16,4,6,12,5,5,
  17,5,7,2,9,7,6,12,13,17,5,5,6,12,10,16,10,16,15,18,6,12,6,8,33,15,14,18,25,14,2,73,13,14,6,20,8,
  12,10,3,11,3,11,13,11,13,10,5,18,10,23,5,9,2,11,9,11,6,11,5,19,15,4,8,9,6,4,4,2,12,12,11,9,7,7,
  8,12,11,23,7,16,46,9,18,12,13,14,14,3,9,15,6,13,13,12,8,11,5,9,8,22,9,2,10,6,10,12,9,11,32,5,11,
  9,11,11,0,9,3,11,11,11,5,4,8,9,30,110)
expect.i <- c(
    6.17,8.44,7.23,5.62,4.18,29.35,11.79,12.35,7.28,9.40,3.77,3.41,8.70,9.57,8.18,4.35,
    4.91,10.66,16.99,2.94,3.07,5.50,6.47,4.85,9.85,6.95,5.74,5.70,2.22,3.46,4.40,4.05,5.74,6.36,5.13,
    16.99,6.19,5.56,11.69,4.69,6.25,10.84,8.40,13.19,9.25,16.98,8.39,2.86,9.70,12.12,12.94,9.77,
    10.34,5.09,3.29,17.19,5.42,11.39,8.33,4.97,7.14,6.74,17.01,5.80,4.84,12.00,4.50,4.39,16.35,6.02,
    6.42,5.26,4.59,11.86,4.05,5.48,13.13,8.72,2.87,2.13,4.48,5.85,6.67,6.11,5.78,12.31,10.56,10.23,
    2.52,6.22,14.29,5.71,37.93,7.81,9.86,11.61,18.52,12.28,5.41,61.96,8.55,12.07,4.29,19.42,8.25,
    12.90,4.76,5.56,11.11,4.76,10.48,13.13,12.94,14.61,9.26,6.94,16.82,33.49,20.91,5.32,6.77,8.70,
    12.94,16.07,8.87,7.79,14.60,5.10,24.42,17.78,4.04,7.84,9.89,8.45,5.06,4.49,6.25,9.16,12.37,8.40,
    9.57,5.83,9.21,9.64,9.09,12.94,17.42,10.29,7.14,92.50,14.29,15.61,6.00,8.55,15.22,18.42,5.77,
    18.37,13.16,7.69,14.61,15.85,12.77,7.41,14.86,6.94,5.66,9.88,102.16,7.63,5.13,7.58,8.00,12.82,
    18.75,12.33,5.88,64.64,8.62,12.09,11.11,14.10,10.48,7.00,10.23,6.82,15.71,9.65,8.59,8.33,6.06,
    12.31,8.91,50.10,288.00)
aff.i <- c(0.2415,0.2309,0.3999,0.2977,0.3264,0.3346,0.4150,0.4202,0.1023,0.1752,
        0.2548,0.3248,0.2287,0.2520,0.2058,0.2785,0.2528,0.1847,0.3736,0.2411,
        0.3700,0.2997,0.2883,0.2427,0.3782,0.1865,0.2633,0.2978,0.3541,0.4176,
        0.2910,0.3431,0.1168,0.2195,0.2911,0.4297,0.2119,0.2698,0.0874,0.3204,
        0.1839,0.1796,0.2471,0.2016,0.1560,0.3162,0.0732,0.1490,0.2283,0.1187,
        0.3500,0.2915,0.1339,0.0995,0.2355,0.2392,0.0877,0.3571,0.1014,0.0363,
        0.1665,0.1226,0.2186,0.1279,0.0842,0.0733,0.0377,0.2216,0.3062,0.0310,
        0.0755,0.0583,0.2546,0.2933,0.1682,0.2518,0.1971,0.1473,0.2311,0.2471,
        0.3063,0.1526,0.1487,0.3537,0.2753,0.0849,0.1013,0.1622,0.1267,0.2376,
        0.0737,0.2755,0.0152,0.1415,0.1344,0.1058,0.0545,0.1047,0.1335,0.3134,
        0.1326,0.1222,0.1992,0.0620,0.1313,0.0848,0.2687,0.1396,0.1234,0.0997,
        0.0694,0.1022,0.0779,0.0253,0.1012,0.0999,0.0828,0.2950,0.0778,0.1388,
        0.2449,0.0978,0.1144,0.1038,0.1613,0.1921,0.2714,0.1467,0.1783,0.1790,
        0.1482,0.1383,0.0805,0.0619,0.1934,0.1315,0.1050,0.0702,0.1002,0.1445,
        0.0353,0.0400,0.1385,0.0491,0.0520,0.0640,0.1017,0.0837,0.1462,0.0958,
        0.0745,0.2942,0.2278,0.1347,0.0907,0.1238,0.1773,0.0623,0.0742,0.1003,
        0.0590,0.0719,0.0652,0.1687,0.1199,0.1768,0.1638,0.1360,0.0832,0.2174,
        0.1662,0.2023,0.1319,0.0526,0.0287,0.0405,0.1616,0.0730,0.1005,0.0743,
        0.0577,0.0481,0.1002,0.0433,0.0838,0.1124,0.2265,0.0436,0.1402,0.0313,
        0.0359,0.0696,0.0618,0.0932,0.0097)
```


## Question 1

Explain a bit more what the `expect.i` variable is. For example, if a particular area has an expected deaths of 16, what does this mean?

The expected death is the expected number of lip cancer deaths of a particular region given that region's age distribution and the national level age-specific mortality rates. For example, let's say an implied number of deaths of 19, this means that based on the area's age distribution, we would expect an average death of 19 if this region were to experience the same age specific mortality rate as the national level.

## Question 2

Run four different models in Stan with three different set-ups for estimating $\theta_i$, that is the relative risk of lip cancer in each region:

1. Intercept $\alpha_i$ is same in each region $= \alpha$ 
2. Intercept $\alpha_i$ is different in each region and modeled separately
3. Intercept $\alpha_i$ is different in each region and the intercept is modeled hierarchically 

Note in all three cases, use the proportion of male population working outside in each region as a covariate.

Given:
$$
u_i|\theta_i \sim \text{Poisson}(\theta_i \cdot e_i)
$$

Model 1 (Intercept $\alpha_i$ is same in each region $= \alpha$ ):
$$
\text{Model 1: }\log \theta_i = \alpha + \beta x_i
$$
Model 2 (Intercept $\alpha_i$ is different in each region and modeled separately):
$$
\text{Model 2: }\log \theta_i = \alpha_i + \beta x_i
$$
Model 3 (Intercept $\alpha_i$ is different in each region and the intercept is modeled hierarchically): 
$$
\text{Model 3: }\log \theta_i = \alpha_i + \beta x_i
$$
and 
$$
\alpha_i \sim N(\mu, \sigma^2)
$$
```{r}
# Load packages
library(rstan)
library(tidybayes)
library(tidyverse)

stan_data <- list(N = length(observe.i),
                  log_y = log(expect.i),
                  x = aff.i - mean(aff.i),
                  y = observe.i)
```
```{r}
model1 <- stan(data = stan_data, 
               file = "model1.stan", 
               iter = 2000, 
               seed = 2201)
```
```{r}
summary_model1 <- summary(model1)

estimators <- summary_model1$summary[c("alpha", "beta"), ]
print(estimators)
```
```{r}
stan_data <- list(N = length(observe.i),
                  log_y = log(expect.i),
                  x = aff.i - mean(aff.i),
                  y = observe.i)

model2 <- stan(data = stan_data, 
               file = "model2.stan", 
               iter = 2000,
               seed = 2201)
```
```{r}
summary_model2 <- summary(model2)

alpha_2 <- summary_model2$summary
beta_2 <- summary_model2$summary[c("beta"), ]

print(alpha_2)
print(beta_2)
```
```{r}
stan_data <- list(N = length(observe.i),
                  log_y = log(expect.i),
                  x = aff.i - mean(aff.i),
                  y = observe.i)

model3 <- stan(data = stan_data, 
               file = "model3.stan", 
               iter = 2000,
               seed = 2201)
```
```{r}
summary_model3 <- summary(model3)

alpha_3 <- summary_model3$summary
estimators_3 <- summary_model3$summary[c("beta", "mu", "sigma"), ]

print(head(alpha_3))
print(estimators_3)
```
## Question 3

Make two plots (appropriately labeled and described) that illustrate the differences in estimated $\theta_i$'s across regions and the differences in $\theta$s across models. 

# plot 1 differences in estimated $\theta_i$:
```{r}
input <- aff.i - mean(aff.i)
alpha_1 <- summary_model1$summary[c("alpha"), "mean"]
beta_1 <- summary_model1$summary[c("beta"), "mean"]
theta_1 <- exp(alpha_1 + beta_1 * input)

alpha_2 <- summary_model2$summary[,"mean"]
beta_2 <- summary_model2$summary[c("beta"), "mean"]
theta_2 <- exp(alpha_2 + beta_2 * input)

alpha_3 <- summary_model3$summary[, "mean"]
beta_3 <- summary_model3$summary[c("beta"), "mean"]
theta_3 <- exp(alpha_3 + beta_3 * input)
```
```{r}
library(ggplot2)

min_length <- min(length(theta_1), length(theta_2), length(theta_3))

theta_1 <- theta_1[1:min_length]
theta_2 <- theta_2[1:min_length]
theta_3 <- theta_3[1:min_length]

models <- c(rep("Model 1", min_length), rep("Model 2", min_length), rep("Model 3", min_length))
regions <- rep(1:min_length, 3)

plot_data <- data.frame(theta_i = c(theta_1, theta_2, theta_3), model = models, region = regions)

ggplot(plot_data, aes(x = region, y = theta_i, color = model, group = model)) +
  geom_line() + 
  geom_point(size = 1.2, shape = 21, fill = "white") + 
  scale_color_manual(values = c("Model 1" = "blue", "Model 2" = "green", "Model 3" = "red")) +
  labs(title = "Estimated Theta_i's Across Regions by Model",
       subtitle = "Line and point plot showing estimated Theta_i values for each region across different models",
       x = "Region Index",
       y = "Estimated Theta_i",
       color = "Model") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(size = 12),
        legend.title = element_text(face = "bold"),
        legend.position = "right",
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12, face = "bold"))

```
```{r}
library(tidybayes)
library(dplyr)
library(ggplot2)

theta_results1 <- model1 %>%
  gather_draws(log_theta[i]) %>%
  median_qi() %>%
  rename(theta_median1 = .value,
         theta_lower1 = .lower,
         theta_upper1 = .upper) %>%
  select(i, theta_median1: theta_upper1)

theta_results2 <- model2 %>%
  gather_draws(log_theta[i]) %>%
  median_qi() %>%
  rename(theta_median2 = .value,
         theta_lower2 = .lower,
         theta_upper2 = .upper) %>%
  select(i, theta_median2: theta_upper2)

theta_results3 <- model3 %>%
  gather_draws(log_theta[i]) %>%
  median_qi() %>%
  rename(theta_median3 = .value,
         theta_lower3 = .lower,
         theta_upper3 = .upper) %>%
  select(i, theta_median3: theta_upper3)

all_model_results <- theta_results1 %>%
  left_join(theta_results2, by = "i") %>%
  left_join(theta_results3, by = "i")

all_model_results %>%
  select(theta_median1, theta_median2, theta_median3) %>%
  pivot_longer(cols = everything(), names_to = "model", values_to = "log_theta") %>%
  mutate(model = fct_recode(model, "Model 1" = "theta_median1", "Model 2" = "theta_median2", "Model 3" = "theta_median3")) %>%
  ggplot(aes(x = log_theta, fill = model)) +
  geom_histogram(position = "dodge", bins = 30, alpha = 0.6, color = "black") +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Distribution of Estimated log(Theta_i) Across Models",
       subtitle = "Comparing median log(Theta_i) values from three different models",
       x = "log(Theta_i)",
       y = "Frequency",
       fill = "Model") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "italic"),
        legend.title = element_text(face = "bold"),
        legend.position = "top",
        axis.title = element_text(face = "bold")) +
  guides(fill = guide_legend(reverse = TRUE))
```
Well this plot tells a lot of stories, we see that the the distribution of model 2's $\theta_i$ has the largest spread and thus it has the highest standard deviation. It seems that all three model's $\theta_i$ centered around 0, and model 3's $\theta_i$ seems to be better distributed than model 1 and model 2.

```{r}
library(ggplot2)

all_model_results %>%
  mutate(deaths = observe.i) %>%
  mutate(log_smr = log(observe.i / expect.i)) %>%
  ggplot() +
  geom_point(aes(x = log_smr, y = theta_median1, color = "Model 1"), size = 3, alpha = 0.6) +
  geom_errorbar(aes(x = log_smr, ymin = theta_lower1, ymax = theta_upper1, color = "Model 1"), width = 0.2, alpha = 0.6) +
  geom_point(aes(x = log_smr, y = theta_median2, color = "Model 2"), size = 3, alpha = 0.6) +
  geom_errorbar(aes(x = log_smr, ymin = theta_lower2, ymax = theta_upper2, color = "Model 2"), width = 0.2, alpha = 0.6) +
  geom_point(aes(x = log_smr, y = theta_median3, color = "Model 3"), size = 3, alpha = 0.6) +
  geom_errorbar(aes(x = log_smr, ymin = theta_lower3, ymax = theta_upper3, color = "Model 3"), width = 0.2, alpha = 0.6) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  labs(
    title = "Comparison of Log Relative Risk Across Models",
    x = "Log(SMR)",
    y = "Estimated Log(Theta)",
    color = "Model",
    size = "Number of Deaths"
  ) +
  scale_color_manual(values = c("Model 1" = "red", "Model 2" = "blue", "Model 3" = "green")) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 14, face = "italic"),
    axis.text = element_text(size = 12)
  )

```
From the above result, we can see that Model 3 captures the general trend better than model 1 and model 2 (model 2 has more uncertainty than model 3 as well).

## Question 4

Using tool of your choice, decide which model is the best, and justify your choice. 

```{r}
library(rstan)
library(loo)
log_lik_1 <- rstan::extract(model1)[["log_lik"]]
loo_statistics_model1 <- loo::loo(log_lik_1, save_psis = TRUE)

log_lik_2 <- rstan::extract(model2)[["log_lik"]]
loo_statistics_model2 <- loo::loo(log_lik_2, save_psis = TRUE)

log_lik_3 <- rstan::extract(model3)[["log_lik"]]
loo_statistics_model3 <- loo::loo(log_lik_3, save_psis = TRUE)
loo_compare(loo_statistics_model1,loo_statistics_model2,loo_statistics_model3)
```
Well, based on the above elpd result, we see that model 3 has the largest elpd result and thus this is the best model with the highest predictive performance. 